{% extends 'converter/base.html' %}

{% block title %}–ü–∞–∫–µ—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .batch-upload-zone {
        min-height: 300px;
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }

    .batch-upload-zone.dragover {
        border-color: var(--bs-primary);
        background: rgba(13, 110, 253, 0.1);
    }

    .file-queue {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        background: white;
    }

    .queue-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        border-bottom: 1px solid #f1f3f4;
        margin-bottom: 0.5rem;
    }

    .queue-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .queue-progress {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .queue-progress-bar {
        height: 100%;
        background: var(--bs-success);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .batch-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin: 2rem 0;
    }

    .stat-box {
        text-align: center;
        padding: 1rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
        margin-bottom: 0.5rem;
    }

    .conversion-controls {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin: 2rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-3">‚ö° <span data-translate="batch-title">–ü–∞–∫–µ—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</span></h1>
            <p class="lead text-muted" data-translate="batch-desc">
                –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
            </p>
        </div>
    </div>

    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="batch-upload-zone" id="batch-upload-zone">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìÇ</div>
                    <h4 data-translate="drop-here-batch">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏</h4>
                    <p class="text-muted" data-translate="batch-multi-supported">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤</p>
                    <input type="file" id="batch-file-input" multiple style="display: none;" accept="*/*">
                    <button type="button" class="btn btn-primary btn-lg mt-3" onclick="document.getElementById('batch-file-input').click()">
                        <i class="bi bi-folder-plus"></i> <span data-translate="choose-files">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—á–µ—Ä–µ–¥—å —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4" id="file-queue-section" style="display: none;">
        <div class="col-12">
            <h5><i class="bi bi-list-ol"></i> <span data-translate="queue-title">–û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏</span></h5>
            <div class="file-queue" id="file-queue"></div>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π -->
    <div class="conversion-controls" id="conversion-controls" style="display: none;">
        <div class="row">
            <div class="col-md-6">
                <h5><i class="bi bi-gear-fill"></i> <span data-translate="batch-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏</span></h5>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="auto-detect-settings" checked>
                        <label class="form-check-label" for="auto-detect-settings" data-translate="autodetect-optimal">
                            –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="preserve-quality" checked>
                        <label class="form-check-label" for="preserve-quality" data-translate="preserve-quality">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="compress-output">
                        <label class="form-check-label" for="compress-output" data-translate="compress-output">
                            –°–∂–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h5><i class="bi bi-speedometer2"></i> <span data-translate="performance">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span></h5>
                
                <div class="mb-3">
                    <label for="concurrent-jobs" class="form-label" data-translate="concurrent-jobs">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á</label>
                    <select class="form-select" id="concurrent-jobs">
                        <option value="1">1 (–º–µ–¥–ª–µ–Ω–Ω–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ)</option>
                        <option value="2" selected>2 (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)</option>
                        <option value="4">4 (–±—ã—Å—Ç—Ä–æ)</option>
                        <option value="8">8 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="priority-mode" class="form-label" data-translate="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select class="form-select" id="priority-mode">
                        <option value="quality" selected data-translate="priority-quality">–ö–∞—á–µ—Å—Ç–≤–æ</option>
                        <option value="speed" data-translate="priority-speed">–°–∫–æ—Ä–æ—Å—Ç—å</option>
                        <option value="size" data-translate="priority-size">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="button" class="btn btn-success btn-lg" id="start-batch-conversion">
                <i class="bi bi-play-circle-fill"></i> <span data-translate="start-batch">–ù–∞—á–∞—Ç—å –ø–∞–∫–µ—Ç–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é</span>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg ms-3" id="clear-queue">
                <i class="bi bi-trash"></i> <span data-translate="clear-queue">–û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</span>
            </button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="batch-stats" id="batch-stats" style="display: none;">
        <h4 class="text-center mb-4" data-translate="batch-stats-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number" id="total-queued">0</span>
                    <span class="stat-label" data-translate="total-queued">–í—Å–µ–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number" id="currently-processing">0</span>
                    <span class="stat-label" data-translate="currently-processing">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number" id="completed-jobs">0</span>
                    <span class="stat-label" data-translate="completed-status">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number" id="failed-jobs">0</span>
                    <span class="stat-label" data-translate="errors">–û—à–∏–±–æ–∫</span>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <div class="progress" style="height: 10px;">
                <div class="progress-bar" id="overall-progress" style="width: 0%"></div>
            </div>
            <small class="mt-2 d-block" data-translate="overall-progress">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</small>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="row mt-4" id="batch-results" style="display: none;">
        <div class="col-12">
            <h5><i class="bi bi-check-circle-fill text-success"></i> <span data-translate="conversion-results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</span></h5>
            <div id="results-container" class="row"></div>
            
            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg" id="download-all">
                    <i class="bi bi-download"></i> <span data-translate="download-all-results">–°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let batchQueue = [];
let processingStats = {
    total: 0,
    processing: 0,
    completed: 0,
    failed: 0
};
let isProcessing = false;

document.addEventListener('DOMContentLoaded', function() {
    setupBatchInterface();
});

function setupBatchInterface() {
    const uploadZone = document.getElementById('batch-upload-zone');
    const fileInput = document.getElementById('batch-file-input');

    // Drag & Drop
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = e.dataTransfer.files;
        addFilesToQueue(files);
    });

    fileInput.addEventListener('change', function() {
        addFilesToQueue(this.files);
    });

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('start-batch-conversion').addEventListener('click', startBatchProcessing);
    document.getElementById('clear-queue').addEventListener('click', clearQueue);
    document.getElementById('download-all').addEventListener('click', downloadAllResults);
}

function addFilesToQueue(files) {
    const fileArray = Array.from(files);
    
    fileArray.forEach(file => {
        const queueItem = {
            id: Date.now() + Math.random(),
            file: file,
            status: 'queued',
            progress: 0,
            type: detectFileType(file.name),
            result: null,
            error: null
        };
        
        batchQueue.push(queueItem);
    });

    updateQueueDisplay();
    updateStats();
    showQueueSection();
}

function updateQueueDisplay() {
    const queueContainer = document.getElementById('file-queue');
    
    if (batchQueue.length === 0) {
        queueContainer.innerHTML = '<p class="text-muted text-center" data-translate="queue-empty">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</p>';
        return;
    }

    const html = batchQueue.map(item => {
        const statusIcons = {
            'queued': '‚è≥',
            'processing': 'üîÑ',
            'completed': '‚úÖ',
            'failed': '‚ùå'
        };

        const statusTexts = {
            'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
            'processing': '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'failed': '–û—à–∏–±–∫–∞'
        };

        return `
            <div class="queue-item">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <span class="me-2" style="font-size: 1.2rem;">${statusIcons[item.status]}</span>
                        <div>
                            <div class="fw-bold">${item.file.name}</div>
                            <small class="text-muted">
                                ${(item.file.size / 1024 / 1024).toFixed(1)} MB ‚Ä¢ ${item.type} ‚Ä¢ ${statusTexts[item.status]}
                            </small>
                        </div>
                    </div>
                    ${item.status === 'processing' || item.status === 'completed' ? `
                        <div class="queue-progress">
                            <div class="queue-progress-bar" style="width: ${item.progress}%"></div>
                        </div>
                    ` : ''}
                    ${item.error ? `
                        <div class="text-danger small mt-1">${item.error}</div>
                    ` : ''}
                </div>
                <div class="ms-3">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromQueue('${item.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');

    queueContainer.innerHTML = html;
}

function showQueueSection() {
    document.getElementById('file-queue-section').style.display = 'block';
    document.getElementById('conversion-controls').style.display = 'block';
}

function removeFromQueue(itemId) {
    batchQueue = batchQueue.filter(item => item.id != itemId);
    updateQueueDisplay();
    updateStats();
    
    if (batchQueue.length === 0) {
        document.getElementById('file-queue-section').style.display = 'none';
        document.getElementById('conversion-controls').style.display = 'none';
    }
}

function clearQueue() {
    if (isProcessing) {
        if (!confirm('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å?')) {
            return;
        }
    }
    
    batchQueue = [];
    processingStats = { total: 0, processing: 0, completed: 0, failed: 0 };
    isProcessing = false;
    
    updateQueueDisplay();
    updateStats();
    
    document.getElementById('file-queue-section').style.display = 'none';
    document.getElementById('conversion-controls').style.display = 'none';
    document.getElementById('batch-stats').style.display = 'none';
    document.getElementById('batch-results').style.display = 'none';
}

async function startBatchProcessing() {
    if (batchQueue.length === 0 || isProcessing) return;

    isProcessing = true;
    processingStats.total = batchQueue.length;
    processingStats.processing = 0;
    processingStats.completed = 0;
    processingStats.failed = 0;

    document.getElementById('batch-stats').style.display = 'block';
    updateStats();

    const concurrentJobs = parseInt(document.getElementById('concurrent-jobs').value);
    const priorityMode = document.getElementById('priority-mode').value;
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
    if (priorityMode === 'size') {
        batchQueue.sort((a, b) => a.file.size - b.file.size);
    } else if (priorityMode === 'speed') {
        // –ü—Ä–æ—Å—Ç—ã–µ —Ñ–∞–π–ª—ã (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) –≤ –Ω–∞—á–∞–ª–æ
        batchQueue.sort((a, b) => {
            const priority = { 'image': 1, 'video': 2, 'audio': 3, 'document': 4, 'archive': 5 };
            return (priority[a.type] || 10) - (priority[b.type] || 10);
        });
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–∞–∫–µ—Ç–∞–º–∏
    const batches = [];
    for (let i = 0; i < batchQueue.length; i += concurrentJobs) {
        batches.push(batchQueue.slice(i, i + concurrentJobs));
    }

    for (const batch of batches) {
        const promises = batch.map(item => processBatchItem(item));
        await Promise.all(promises);
        updateStats();
    }

    isProcessing = false;
    showResults();
}

async function processBatchItem(item) {
    try {
        item.status = 'processing';
        item.progress = 0;
        processingStats.processing++;
        updateQueueDisplay();
        updateStats();

        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const progressInterval = setInterval(() => {
            if (item.progress < 90) {
                item.progress += Math.random() * 20;
                updateQueueDisplay();
            }
        }, 500);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        const result = await convertBatchFile(item);

        clearInterval(progressInterval);
        item.progress = 100;

        if (result.success) {
            item.status = 'completed';
            item.result = result;
            processingStats.completed++;
        } else {
            item.status = 'failed';
            item.error = result.error;
            processingStats.failed++;
        }

        processingStats.processing--;
        updateQueueDisplay();

    } catch (error) {
        item.status = 'failed';
        item.error = error.message;
        processingStats.processing--;
        processingStats.failed++;
        updateQueueDisplay();
    }
}

async function convertBatchFile(item) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
    // –ü–æ–∫–∞ —á—Ç–æ —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞
    return new Promise((resolve) => {
        setTimeout(() => {
            if (Math.random() > 0.1) { // 90% —É—Å–ø–µ—Ö–∞
                resolve({
                    success: true,
                    output_url: '/media/converted/' + item.file.name.replace(/\.[^/.]+$/, '_converted.jpg'),
                    metadata: {
                        original_size: item.file.size,
                        output_format: item.type === 'video' ? 'gif' : 'jpg'
                    }
                });
            } else {
                resolve({
                    success: false,
                    error: '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞'
                });
            }
        }, Math.random() * 3000 + 1000); // 1-4 —Å–µ–∫—É–Ω–¥—ã
    });
}

function updateStats() {
    document.getElementById('total-queued').textContent = processingStats.total;
    document.getElementById('currently-processing').textContent = processingStats.processing;
    document.getElementById('completed-jobs').textContent = processingStats.completed;
    document.getElementById('failed-jobs').textContent = processingStats.failed;

    const progress = processingStats.total > 0 ? 
        ((processingStats.completed + processingStats.failed) / processingStats.total) * 100 : 0;
    document.getElementById('overall-progress').style.width = progress + '%';
}

function showResults() {
    const completedItems = batchQueue.filter(item => item.status === 'completed');
    
    if (completedItems.length === 0) {
        return;
    }

    const resultsContainer = document.getElementById('results-container');
    const html = completedItems.map(item => `
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">${item.file.name}</h6>
                    <p class="card-text small text-muted">
                        ${item.type} ‚Üí ${item.result.metadata?.output_format || 'Converted'}
                    </p>
                    <div class="btn-group w-100">
                        <button type="button" class="btn btn-primary btn-sm" onclick="downloadResult('${item.result.output_url}')">
                            <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="previewResult('${item.result.output_url}')">
                            <i class="bi bi-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    resultsContainer.innerHTML = html;
    document.getElementById('batch-results').style.display = 'block';
}

function downloadResult(url) {
    const link = document.createElement('a');
    link.href = url;
    link.download = url.split('/').pop();
    link.click();
}

function downloadAllResults() {
    const completedItems = batchQueue.filter(item => item.status === 'completed');
    completedItems.forEach(item => {
        setTimeout(() => downloadResult(item.result.output_url), 100);
    });
}

function previewResult(url) {
    window.open(url, '_blank');
}

function detectFileType(filename) {
    const ext = filename.toLowerCase().split('.').pop();
    const typeMap = {
        'mp4': 'video', 'avi': 'video', 'mov': 'video', 'mkv': 'video',
        'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image',
        'mp3': 'audio', 'wav': 'audio', 'flac': 'audio',
        'pdf': 'document', 'doc': 'document', 'docx': 'document',
        'zip': 'archive', 'rar': 'archive', '7z': 'archive'
    };
    return typeMap[ext] || 'unknown';
}
</script>
{% endblock %}
