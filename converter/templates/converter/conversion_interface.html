{% extends 'converter/base.html' %}

{% block title %}–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .conversion-selector {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .conversion-selector:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .conversion-selector.active {
        border-color: #0d6efd;
        background-color: #e3f2fd;
        border-style: solid;
    }
    .format-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    .format-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #333;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .format-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
        color: #333;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .format-card.selected {
        border-color: #0d6efd;
        background-color: #e3f2fd;
        border-width: 2px;
        color: #0d47a1;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }
    .file-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        color: #666;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .file-drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e3f2fd;
    }
    .file-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .file-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background-color: white;
    }
    .file-item .file-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .progress {
        height: 6px;
    }
    .conversion-params {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .param-group {
        margin-bottom: 1rem;
    }
    .format-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
    .format-card strong {
        color: inherit;
        font-size: 1.1rem;
    }
    
    .format-card small {
        color: #666 !important;
    }
    
    .format-card.selected small {
        color: #0d47a1 !important;
    }
    
    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ */
    [data-theme="dark"] .conversion-selector {
        border-color: rgba(102, 126, 234, 0.6);
        background: rgba(31, 41, 55, 0.8);
    }
    
    [data-theme="dark"] .format-card {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.4);
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card strong {
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card small {
        color: #d1d5db !important;
    }
    
    [data-theme="dark"] .format-card:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card:hover strong {
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card:hover small {
        color: #e5e7eb !important;
    }
    
    [data-theme="dark"] .format-card.selected {
        background: rgba(102, 126, 234, 0.3);
        border-color: #667eea;
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card.selected strong {
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card.selected small {
        color: #e5e7eb !important;
    }
    
    [data-theme="dark"] .file-drop-zone {
        background: rgba(31, 41, 55, 0.8);
        border-color: rgba(102, 126, 234, 0.6);
        color: #ffffff;
    }
    
    [data-theme="dark"] .file-drop-zone:hover,
    [data-theme="dark"] .file-drop-zone.dragover {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
    }
    
    [data-theme="dark"] .file-item {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.4);
        color: #ffffff;
    }
    
    [data-theme="dark"] .conversion-params {
        background: rgba(31, 41, 55, 0.8);
        color: #ffffff;
    }
    
    [data-theme="dark"] .param-group label {
        color: #ffffff !important;
    }
    
    [data-theme="dark"] .modal-content {
        background: rgba(17, 24, 39, 0.95);
        color: #ffffff;
    }
    
    [data-theme="dark"] .modal-header {
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    [data-theme="dark"] .modal-footer {
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    [data-theme="dark"] .list-group-item {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.3);
        color: #ffffff;
    }
    
    /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ */
    @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) .conversion-selector {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(31, 41, 55, 0.8);
        }
        
        :root:not([data-theme="light"]) .format-card {
            background: rgba(55, 65, 81, 0.8);
            border-color: rgba(102, 126, 234, 0.4);
            color: #ffffff;
        }
        
        :root:not([data-theme="light"]) .file-drop-zone {
            background: rgba(31, 41, 55, 0.8);
            border-color: rgba(102, 126, 234, 0.6);
            color: #ffffff;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-arrow-left-right"></i>
            <span data-translate="conversion-interface-title">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤</span>
        </h1>
    </div>

    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 data-translate="select-conversion-type">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
            <div class="conversion-selector" id="conversion-selector">
                <div class="row">
                    <div class="col-md-5">
                        <h5 data-translate="from">–ò–ó</h5>
                        <div class="format-grid" id="source-formats">
                            <div class="format-card" data-format="video">
                                <span class="format-icon">üé¨</span>
                                <strong data-translate="video">–í–∏–¥–µ–æ</strong>
                                <small class="d-block text-muted">MP4, AVI, MOV, MKV</small>
                            </div>
                            <div class="format-card" data-format="image">
                                <span class="format-icon">üñºÔ∏è</span>
                                <strong data-translate="images">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</strong>
                                <small class="d-block text-muted">JPG, PNG, BMP, TIFF</small>
                            </div>
                            <div class="format-card" data-format="audio">
                                <span class="format-icon">üéµ</span>
                                <strong data-translate="audio">–ê—É–¥–∏–æ</strong>
                                <small class="d-block text-muted">MP3, WAV, FLAC, AAC</small>
                            </div>
                            <div class="format-card" data-format="document">
                                <span class="format-icon">üìÑ</span>
                                <strong data-translate="documents">–î–æ–∫—É–º–µ–Ω—Ç—ã</strong>
                                <small class="d-block text-muted">PDF, DOC, DOCX, TXT</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-arrow-right display-4 text-primary"></i>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h5 data-translate="to">–í</h5>
                        <div class="format-grid" id="target-formats">
                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4" id="upload-section" style="display: none;">
        <div class="col-12">
            <h3 data-translate="upload-files">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
            <div class="file-drop-zone" id="file-drop-zone">
                <i class="bi bi-cloud-upload display-1 text-primary"></i>
                <h4 data-translate="drag-files">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h4>
                <p class="text-muted" data-translate="multiple-files-supported">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 100MB</p>
                <input type="file" id="file-input" multiple accept="" style="display: none;">
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4" id="files-section" style="display: none;">
        <div class="col-12">
            <h3><span data-translate="uploaded-files">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</span> (<span id="file-count">0</span>)</h3>
            <div class="file-list" id="file-list">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
        </div>
    </div>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
    <div class="row mb-4" id="params-section" style="display: none;">
        <div class="col-12">
            <div class="conversion-params">
                <h3 data-translate="conversion-params">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
                <div id="conversion-parameters">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="row mb-4" id="actions-section" style="display: none;">
        <div class="col-12">
            <div class="d-flex gap-3">
                <button class="btn btn-primary btn-lg" id="start-conversion" disabled>
                    <i class="bi bi-play-fill"></i>
                    <span data-translate="start-conversion">–ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é</span>
                </button>
                <button class="btn btn-secondary" id="clear-files">
                    <i class="bi bi-trash"></i>
                    <span data-translate="clear-list">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
                </button>
                <button class="btn btn-info" id="refresh-queue">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span data-translate="refresh-queue">–û–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á -->
    <div class="row mb-4" id="queue-section" style="display: none;">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>
                    <i class="bi bi-list-task"></i>
                    <span data-translate="conversion-queue">–û—á–µ—Ä–µ–¥—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</span>
                </h3>
                <button class="btn btn-outline-secondary btn-sm" id="toggle-queue">
                    <i class="bi bi-chevron-up"></i>
                    –°–≤–µ—Ä–Ω—É—Ç—å
                </button>
            </div>
            <div id="queue-content" class="conversion-params">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
class ConversionInterface {
    constructor() {
        this.selectedSourceFormat = null;
        this.selectedTargetFormat = null;
        this.uploadedFiles = [];
        this.currentModal = null;
        this.modalCleanupTimer = null;
        this.conversionTypes = {
            video: {
                name: '–í–∏–¥–µ–æ',
                targets: {
                    'gif': { name: 'GIF', icon: 'üéûÔ∏è', description: '–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
                    'mp4': { name: 'MP4', icon: 'üé¨', description: '–í–∏–¥–µ–æ —Ñ–æ—Ä–º–∞—Ç' },
                    'webm': { name: 'WebM', icon: 'üé•', description: '–í–µ–±-–≤–∏–¥–µ–æ' },
                    'avi': { name: 'AVI', icon: 'üìπ', description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç' },
                    'mp3': { name: 'MP3', icon: 'üéµ', description: '–ò–∑–≤–ª–µ—á—å –∑–≤—É–∫ –∏–∑ –≤–∏–¥–µ–æ' }
                },
                accept: 'video/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            image: {
                name: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
                targets: {
                    'jpg': { name: 'JPG', icon: 'üì∏', description: 'JPEG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
                    'png': { name: 'PNG', icon: 'üñºÔ∏è', description: 'PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é' },
                    'webp': { name: 'WebP', icon: 'üåê', description: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç' },
                    'pdf': { name: 'PDF', icon: 'üìÑ', description: 'PDF –¥–æ–∫—É–º–µ–Ω—Ç' }
                },
                accept: 'image/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            audio: {
                name: '–ê—É–¥–∏–æ',
                targets: {
                    'mp3': { name: 'MP3', icon: 'üéµ', description: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç' },
                    'wav': { name: 'WAV', icon: 'üîä', description: '–ù–µ—Å–∂–∞—Ç—ã–π –∑–≤—É–∫' },
                    'flac': { name: 'FLAC', icon: 'üéº', description: 'Lossless –∫–∞—á–µ—Å—Ç–≤–æ' },
                    'ogg': { name: 'OGG', icon: 'üéß', description: '–û—Ç–∫—Ä—ã—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç' }
                },
                accept: 'audio/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            document: {
                name: '–î–æ–∫—É–º–µ–Ω—Ç—ã',
                targets: {
                    'pdf': { name: 'PDF', icon: 'üìÑ', description: 'PDF –¥–æ–∫—É–º–µ–Ω—Ç' },
                    'docx': { name: 'DOCX', icon: 'üìù', description: 'Word –¥–æ–∫—É–º–µ–Ω—Ç' },
                    'txt': { name: 'TXT', icon: 'üìÉ', description: '–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª' },
                    'html': { name: 'HTML', icon: 'üåê', description: 'HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞' }
                },
                accept: '.pdf,.doc,.docx,.txt,.rtf,.odt',
                maxSize: 50 * 1024 * 1024 // 50MB
            }
        };
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.setupDragAndDrop();
    }
    
    setupEventListeners() {
        // –í—ã–±–æ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        document.querySelectorAll('#source-formats .format-card').forEach(card => {
            card.addEventListener('click', (e) => {
                this.selectSourceFormat(e.currentTarget.dataset.format);
            });
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        document.getElementById('file-input').addEventListener('change', (e) => {
            this.handleFileSelection(e.target.files);
        });
        
        document.getElementById('file-drop-zone').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        document.getElementById('start-conversion').addEventListener('click', () => {
            this.startConversion();
        });
        
        document.getElementById('clear-files').addEventListener('click', () => {
            this.clearFiles();
        });
        
        document.getElementById('toggle-queue').addEventListener('click', () => {
            this.toggleQueue();
        });
        
        document.getElementById('refresh-queue').addEventListener('click', () => {
            this.refreshQueue();
        });
        
    }
    
    setupDragAndDrop() {
        const dropZone = document.getElementById('file-drop-zone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            this.handleFileSelection(e.dataTransfer.files);
        });
    }
    
    selectSourceFormat(format) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        document.querySelectorAll('#source-formats .format-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        document.querySelector(`#source-formats [data-format="${format}"]`).classList.add('selected');
        
        this.selectedSourceFormat = format;
        this.updateTargetFormats(format);
        this.updateFileInput();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('upload-section').style.display = 'block';
    }
    
    updateTargetFormats(sourceFormat) {
        const targetContainer = document.getElementById('target-formats');
        const targets = this.conversionTypes[sourceFormat].targets;
        
        targetContainer.innerHTML = '';
        
        Object.entries(targets).forEach(([format, info]) => {
            const card = document.createElement('div');
            card.className = 'format-card';
            card.dataset.format = format;
            card.innerHTML = `
                <span class="format-icon">${info.icon}</span>
                <strong>${info.name}</strong>
                <small class="d-block text-muted">${info.description}</small>
            `;
            
            card.addEventListener('click', () => {
                this.selectTargetFormat(format);
            });
            
            targetContainer.appendChild(card);
        });
    }
    
    selectTargetFormat(format) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        document.querySelectorAll('#target-formats .format-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        document.querySelector(`#target-formats [data-format="${format}"]`).classList.add('selected');
        
        this.selectedTargetFormat = format;
        this.updateConversionParameters();
    }
    
    updateFileInput() {
        const fileInput = document.getElementById('file-input');
        const acceptType = this.conversionTypes[this.selectedSourceFormat].accept;
        fileInput.accept = acceptType;
    }
    
    handleFileSelection(files) {
        Array.from(files).forEach(file => {
            if (this.validateFile(file)) {
                this.uploadedFiles.push({
                    file: file,
                    id: Date.now() + Math.random(),
                    status: 'ready',
                    progress: 0
                });
            }
        });
        
        this.updateFileList();
        this.updateUI();
    }
    
    validateFile(file) {
        const sourceFormat = this.conversionTypes[this.selectedSourceFormat];
        
        if (file.size > sourceFormat.maxSize) {
            alert(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${this.formatFileSize(sourceFormat.maxSize)}`);
            return false;
        }
        
        return true;
    }
    
    updateFileList() {
        const fileList = document.getElementById('file-list');
        const fileCount = document.getElementById('file-count');
        
        fileList.innerHTML = '';
        fileCount.textContent = this.uploadedFiles.length;
        
        this.uploadedFiles.forEach(fileData => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <div>
                        <strong>${fileData.file.name}</strong>
                        <small class="text-muted d-block">${this.formatFileSize(fileData.file.size)}</small>
                    </div>
                    <div>
                        <span class="badge bg-${this.getStatusColor(fileData.status)}">${this.getStatusText(fileData.status)}</span>
                        ${fileData.status === 'done' && fileData.outputUrl ? `
                            <a href="${fileData.outputUrl}" class="btn btn-sm btn-success ms-2" download title="–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª">
                                <i class="bi bi-download"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-primary ms-1" onclick="window.open('${fileData.outputUrl}', '_blank')" title="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                                <i class="bi bi-eye"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="conversionInterface.removeFile('${fileData.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                ${fileData.progress > 0 ? `
                    <div class="progress mt-2">
                        <div class="progress-bar" style="width: ${fileData.progress}%"></div>
                    </div>
                ` : ''}
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    removeFile(fileId) {
        this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
        this.updateFileList();
        this.updateUI();
    }
    
    updateUI() {
        const hasFiles = this.uploadedFiles.length > 0;
        const hasFormats = this.selectedSourceFormat && this.selectedTargetFormat;
        
        document.getElementById('files-section').style.display = hasFiles ? 'block' : 'none';
        document.getElementById('params-section').style.display = hasFormats ? 'block' : 'none';
        document.getElementById('actions-section').style.display = hasFiles && hasFormats ? 'block' : 'none';
        document.getElementById('start-conversion').disabled = !hasFiles || !hasFormats;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É
        if (hasFiles && hasFormats) {
            this.showQueueSection();
        }
    }
    
    updateConversionParameters() {
        const paramsContainer = document.getElementById('conversion-parameters');
        const sourceFormat = this.selectedSourceFormat;
        const targetFormat = this.selectedTargetFormat;
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        let parametersHTML = '';
        
        if (sourceFormat === 'video' && targetFormat === 'gif') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–®–∏—Ä–∏–Ω–∞ (px)</label>
                            <input type="number" class="form-control" value="480" min="144" max="1920">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">FPS</label>
                            <input type="number" class="form-control" value="15" min="10" max="30">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                            <select class="form-select">
                                <option value="medium">–°—Ä–µ–¥–Ω–µ–µ</option>
                                <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                                <option value="low">–ù–∏–∑–∫–æ–µ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="keep-original-size">
                            <label class="form-check-label" for="keep-original-size">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optimize-colors">
                            <label class="form-check-label" for="optimize-colors">
                                –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤
                            </label>
                        </div>
                    </div>
                </div>
            `;
        } else if (sourceFormat === 'image') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="param-group">
                            <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ (–¥–ª—è JPG)</label>
                            <input type="range" class="form-range" min="1" max="100" value="85">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="param-group">
                            <label class="form-label">–†–∞–∑–º–µ—Ä</label>
                            <select class="form-select">
                                <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π</option>
                                <option value="1920x1080">1920x1080</option>
                                <option value="1280x720">1280x720</option>
                                <option value="800x600">800x600</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        } else if (sourceFormat === 'video' && targetFormat === 'mp3') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ë–∏—Ç—Ä–µ–π—Ç (kbps)</label>
                            <select class="form-select" id="audio-bitrate">
                                <option value="128">128</option>
                                <option value="192" selected>192</option>
                                <option value="256">256</option>
                                <option value="320">320</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                            <select class="form-select" id="audio-quality">
                                <option value="low">–ù–∏–∑–∫–æ–µ</option>
                                <option value="medium" selected>–°—Ä–µ–¥–Ω–µ–µ</option>
                                <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞–Ω–∞–ª—ã</label>
                            <select class="form-select" id="audio-channels">
                                <option value="mono">–ú–æ–Ω–æ</option>
                                <option value="stereo" selected>–°—Ç–µ—Ä–µ–æ</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        } else if (sourceFormat === 'audio') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ë–∏—Ç—Ä–µ–π—Ç (kbps)</label>
                            <select class="form-select">
                                <option value="128">128</option>
                                <option value="192">192</option>
                                <option value="256">256</option>
                                <option value="320">320</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏</label>
                            <select class="form-select">
                                <option value="44100">44.1 kHz</option>
                                <option value="48000">48 kHz</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞–Ω–∞–ª—ã</label>
                            <select class="form-select">
                                <option value="mono">–ú–æ–Ω–æ</option>
                                <option value="stereo" selected>–°—Ç–µ—Ä–µ–æ</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        } else {
            parametersHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    –î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
                </div>
            `;
        }
        
        paramsContainer.innerHTML = parametersHTML;
        this.updateUI();
    }
    
    startConversion() {
        if (!this.selectedSourceFormat || !this.selectedTargetFormat || this.uploadedFiles.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        const params = this.getConversionParams();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
        this.uploadedFiles.forEach(fileData => {
            this.submitConversionTask(fileData, params);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
        this.showNotification('–ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É!', 'success');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
        setTimeout(() => {
            this.showQueueSection();
            this.showNotification('–û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'info');
        }, 1000);
    }
    
    getConversionParams() {
        const params = {
            source_format: this.selectedSourceFormat,
            target_format: this.selectedTargetFormat
        };
        
        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Ñ–æ—Ä–º—ã
        document.querySelectorAll('#conversion-parameters input, #conversion-parameters select').forEach(input => {
            if (input.type === 'checkbox') {
                params[input.id.replace('-', '_')] = input.checked;
            } else {
                params[input.id.replace('-', '_')] = input.value;
            }
        });
        
        return params;
    }
    
    async submitConversionTask(fileData, params) {
        const formData = new FormData();
        formData.append('file', fileData.file);
        formData.append('source_format', params.source_format);
        formData.append('target_format', params.target_format);
        formData.append('params', JSON.stringify(params));
        
        try {
            fileData.status = 'uploading';
            this.updateFileList();
            
            const response = await fetch('/app/api/conversion/submit/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                fileData.status = 'done';
                fileData.taskId = result.task_id;
                fileData.outputUrl = result.output_url;
                fileData.fileSize = result.file_size;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                this.showNotification(`–§–∞–π–ª ${fileData.file.name} —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`, 'success');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                this.showConversionResult(fileData);
            } else {
                fileData.status = 'error';
                fileData.errorMessage = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                this.showNotification(`–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ ${fileData.file.name}: ${fileData.errorMessage}`, 'error');
            }
        } catch (error) {
            console.error('Error submitting task:', error);
            fileData.status = 'error';
            fileData.errorMessage = error.message;
            this.showNotification(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ ${fileData.file.name}: ${error.message}`, 'error');
        }
        
        this.updateFileList();
    }
    
    clearFiles() {
        this.uploadedFiles = [];
        this.updateFileList();
        this.updateUI();
    }
    
    async showQueue() {
        try {
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –ª—é–±—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            this.forceCleanupModal();
            
            const modalElement = document.getElementById('queue-modal');
            if (!modalElement) {
                console.error('Queue modal element not found');
                this.showNotification('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Bootstrap –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded');
                this.showNotification('–û—à–∏–±–∫–∞: Bootstrap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',  // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º –∑–∞–∫—Ä—ã—Ç—å –∫–ª–∏–∫–æ–º –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                keyboard: true,
                focus: true
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            this.currentModal = modal;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const onModalShown = async () => {
                console.log('[DEBUG] Modal shown event triggered');
                try {
                    console.log('[DEBUG] Starting queue refresh from modal shown handler');
                    await this.refreshQueue();
                    console.log('[DEBUG] Queue refresh completed successfully');
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                    this.modalCleanupTimer = setTimeout(() => {
                        console.warn('[DEBUG] Modal cleanup timer triggered - forcing cleanup');
                        this.forceCleanupModal();
                    }, 30000); // 30 —Å–µ–∫—É–Ω–¥
                    console.log('[DEBUG] Modal shown handler completed successfully');
                } catch (error) {
                    console.error('[DEBUG] Error in modal shown handler:', error);
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const onModalHidden = () => {
                try {
                    console.log('[DEBUG] Modal hidden event triggered');
                    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
                    if (this.modalCleanupTimer) {
                        console.log('[DEBUG] Clearing modal cleanup timer');
                        clearTimeout(this.modalCleanupTimer);
                        this.modalCleanupTimer = null;
                    }
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    console.log('[DEBUG] Scheduling forced cleanup in 100ms');
                    setTimeout(() => {
                        console.log('[DEBUG] Executing delayed forced cleanup');
                        this.forceCleanupModal();
                    }, 100);
                } catch (error) {
                    console.error('[DEBUG] Error in modal cleanup:', error);
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    this.forceCleanupModal();
                }
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            modalElement.addEventListener('hide.bs.modal', () => {
                console.log('[DEBUG] Modal hide event triggered (about to close)');
            }, { once: true });
            
            modalElement.addEventListener('shown.bs.modal', onModalShown, { once: true });
            modalElement.addEventListener('hidden.bs.modal', onModalHidden, { once: true });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
            const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
            closeButtons.forEach((btn, index) => {
                console.log(`[DEBUG] Found close button ${index}:`, btn);
                btn.addEventListener('click', () => {
                    console.log(`[DEBUG] Close button ${index} clicked`);
                }, { once: true });
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            console.log('[DEBUG] About to show modal...');
            modal.show();
            console.log('[DEBUG] Modal.show() called');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                const isVisible = modalElement.classList.contains('show');
                const hasBackdrop = document.querySelector('.modal-backdrop') !== null;
                const bodyHasModalClass = document.body.classList.contains('modal-open');
                console.log(`[DEBUG] Modal state check: visible=${isVisible}, backdrop=${hasBackdrop}, bodyModalClass=${bodyHasModalClass}`);
                
                if (!isVisible) {
                    console.error('[DEBUG] Modal failed to show properly!');
                    this.showNotification('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'warning');
                }
            }, 500);
            
        } catch (error) {
            console.error('[DEBUG] Exception in showQueue:', error);
            this.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—á–µ—Ä–µ–¥–∏', 'error');
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            this.forceCleanupModal();
        }
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    forceCleanupModal() {
        try {
            console.log('Starting force cleanup of modal...');
            
            // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            this.currentModal = null;
            
            // –£–±–∏—Ä–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—á–∏—Å—Ç–∫–∏ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (this.modalCleanupTimer) {
                clearTimeout(this.modalCleanupTimer);
                this.modalCleanupTimer = null;
            }
            
            const modalElement = document.getElementById('queue-modal');
            if (modalElement) {
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ event listener'—ã
                modalElement.removeEventListener('shown.bs.modal', () => {});
                modalElement.removeEventListener('hidden.bs.modal', () => {});
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.dispose();
                }
                
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ Bootstrap –∫–ª–∞—Å—Å—ã —Å —ç–ª–µ–º–µ–Ω—Ç–∞
                modalElement.classList.remove('show', 'fade');
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
            }
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º –í–°–ï backdrop'—ã
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º body –ø–æ–ª–Ω–æ—Å—Ç—å—é
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.marginRight = '';
            
            // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ overlay'–∏ –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const overlays = document.querySelectorAll('.modal, .modal-backdrop, .fade');
            overlays.forEach(overlay => {
                if (overlay.style) {
                    overlay.style.display = 'none';
                }
            });
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            this.restorePageInteractivity();
            
            console.log('Force cleanup completed successfully');
            
        } catch (error) {
            console.error('Error in force cleanup:', error);
            // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setTimeout(() => {
                this.restorePageInteractivity();
            }, 100);
        }
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    restorePageInteractivity() {
        try {
            console.log('Restoring page interactivity...');
            
            // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ pointer-events –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            document.body.style.pointerEvents = '';
            document.documentElement.style.pointerEvents = '';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã
            document.querySelectorAll('button, .btn').forEach(button => {
                button.style.pointerEvents = '';
                button.disabled = button.hasAttribute('data-disabled');
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã
            document.querySelectorAll('a').forEach(link => {
                link.style.pointerEvents = '';
            });
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            this.reattachEventListeners();
            
            console.log('Page interactivity restored');
            
        } catch (error) {
            console.error('Error restoring page interactivity:', error);
        }
    }
    
    // –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    reattachEventListeners() {
        try {
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const startButton = document.getElementById('start-conversion');
            const clearButton = document.getElementById('clear-files');
            const queueButton = document.getElementById('view-queue');
            const refreshButton = document.getElementById('refresh-queue');
            
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            if (startButton) {
                startButton.onclick = () => this.startConversion();
            }
            
            if (clearButton) {
                clearButton.onclick = () => this.clearFiles();
            }
            
            if (queueButton) {
                queueButton.onclick = () => this.showQueue();
            }
            
            if (refreshButton) {
                refreshButton.onclick = () => this.refreshQueue();
            }
            
            // –ö–∞—Ä—Ç–æ—á–∫–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
            document.querySelectorAll('#source-formats .format-card').forEach(card => {
                card.onclick = (e) => this.selectSourceFormat(e.currentTarget.dataset.format);
            });
            
            console.log('Event listeners reattached successfully');
            
        } catch (error) {
            console.error('Error reattaching event listeners:', error);
        }
    }
    
    async refreshQueue() {
        console.log('[DEBUG] refreshQueue() started');
        const queueContent = document.getElementById('queue-content');
        if (!queueContent) {
            console.error('Queue content element not found');
            return;
        }
        
        console.log('[DEBUG] Setting loading spinner');
        queueContent.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"></div><p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–∏...</p></div>';
        
        try {
            console.log('[DEBUG] Starting fetch request to:', '/app/api/conversion/queue/');
            const response = await fetch('/app/api/conversion/queue/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            console.log('[DEBUG] Queue response received, status:', response.status);
            
            if (response.ok) {
                console.log('[DEBUG] Response OK, parsing JSON...');
                const data = await response.json();
                console.log('[DEBUG] Queue data parsed successfully:', data);
                
                if (data.success !== false) {
                    console.log('[DEBUG] Rendering queue with tasks:', data.tasks?.length || 0);
                    this.renderQueue(data.tasks || []);
                    console.log('[DEBUG] Queue rendered successfully');
                } else {
                    console.error('[DEBUG] Server returned error:', data.error);
                    queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
                }
            } else {
                console.error('[DEBUG] Response not OK, reading error text...');
                const errorText = await response.text();
                console.error('[DEBUG] Queue fetch error response:', errorText);
                queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏ (${response.status})</div>`;
            }
        } catch (error) {
            console.error('[DEBUG] Exception in refreshQueue:', error);
            queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
        }
        
        console.log('[DEBUG] refreshQueue() completed');
    }
    
    renderQueue(tasks) {
        console.log('[DEBUG] renderQueue() started with tasks:', tasks);
        const queueContent = document.getElementById('queue-content');
        
        if (!queueContent) {
            console.error('[DEBUG] Queue content element not found in renderQueue');
            return;
        }
        
        if (!Array.isArray(tasks) || tasks.length === 0) {
            console.log('[DEBUG] No tasks to render, showing empty message');
            queueContent.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ –∏–ª–∏ –∑–∞–¥–∞—á–∏ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã</div>';
            return;
        }
        
        try {
            console.log('[DEBUG] Building HTML for', tasks.length, 'tasks');
            let html = '<div class="list-group">';
            tasks.forEach((task, index) => {
                console.log(`[DEBUG] Processing task ${index}:`, task);
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const filename = this.escapeHtml(task.filename || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–π–ª');
                const sourceFormat = this.escapeHtml(task.source_format || 'unknown');
                const targetFormat = this.escapeHtml(task.target_format || 'unknown');
                const createdAt = task.created_at ? new Date(task.created_at).toLocaleString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const status = task.status || 'unknown';
                const progress = Math.max(0, Math.min(100, parseInt(task.progress) || 0));
                const errorMessage = task.error_message ? this.escapeHtml(task.error_message) : null;
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${filename}</h6>
                            <small>${createdAt}</small>
                        </div>
                        <p class="mb-1">
                            ${sourceFormat} ‚Üí ${targetFormat}
                            <span class="badge bg-${this.getStatusColor(status)} ms-2">${this.getStatusText(status)}</span>
                        </p>
                        ${progress > 0 ? `
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                        ${errorMessage ? `<small class="text-danger">–û—à–∏–±–∫–∞: ${errorMessage}</small>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            console.log('[DEBUG] Setting innerHTML with generated HTML');
            queueContent.innerHTML = html;
            console.log('[DEBUG] Queue rendered successfully');
        } catch (error) {
            console.error('[DEBUG] Error rendering queue:', error);
            queueContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏</div>';
        }
        
        console.log('[DEBUG] renderQueue() completed');
    }
    
    getStatusColor(status) {
        const colors = {
            ready: 'secondary',
            queued: 'info',
            uploading: 'warning',
            running: 'primary',
            done: 'success',
            error: 'danger',
            failed: 'danger'
        };
        return colors[status] || 'secondary';
    }
    
    getStatusText(status) {
        const texts = {
            ready: '–ì–æ—Ç–æ–≤',
            queued: '–í –æ—á–µ—Ä–µ–¥–∏',
            uploading: '–ó–∞–≥—Ä—É–∑–∫–∞',
            running: '–û–±—Ä–∞–±–æ—Ç–∫–∞',
            done: '–ì–æ—Ç–æ–≤–æ',
            error: '–û—à–∏–±–∫–∞',
            failed: '–ù–µ—É–¥–∞—á–∞'
        };
        return texts[status] || status;
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    showNotification(message, type = 'info') {
        try {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${this.escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —ç–∫—Ä–∞–Ω–∏–∑–∞—Ü–∏–∏ HTML
    escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            return String(unsafe || '');
        }
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    clearAllBlockers() {
        try {
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ overlay'–∏ –∏ backdrop'—ã
            const overlays = document.querySelectorAll('.modal-backdrop, .overlay, .loading-overlay, .blocker');
            overlays.forEach(overlay => overlay.remove());
            
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                modal.removeAttribute('aria-modal');
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º body
            document.body.classList.remove('modal-open', 'overflow-hidden');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.marginRight = '';
            document.body.style.pointerEvents = '';
            
            // –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.documentElement.style.pointerEvents = '';
            
            console.log('All blockers cleared');
            
        } catch (error) {
            console.error('Error clearing blockers:', error);
        }
    }
    
    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    setupInterfaceMonitoring() {
        try {
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            this.interfaceMonitor = setInterval(() => {
                this.checkInterfaceHealth();
            }, 3000);
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ DOM –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            this.domObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                if (node.classList && node.classList.contains('modal-backdrop')) {
                                    console.warn('Modal backdrop detected by observer');
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è, –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –ª–∏ backdrop
                                    setTimeout(() => {
                                        this.checkForOrphanBackdrops();
                                    }, 1000);
                                }
                            }
                        });
                    }
                });
            });
            
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ body
            this.domObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('Interface monitoring setup completed');
            
        } catch (error) {
            console.error('Error setting up interface monitoring:', error);
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    checkInterfaceHealth() {
        try {
            let issuesFound = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ orphan backdrop'–æ–≤
            const backdrops = document.querySelectorAll('.modal-backdrop');
            const visibleModals = document.querySelectorAll('.modal.show');
            
            if (backdrops.length > 0 && visibleModals.length === 0) {
                console.warn('Found orphan modal backdrops without visible modals');
                issuesFound = true;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ body
            if (document.body.classList.contains('modal-open') && visibleModals.length === 0) {
                console.warn('Body has modal-open class but no visible modals');
                issuesFound = true;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º pointer events
            const bodyStyle = window.getComputedStyle(document.body);
            if (bodyStyle.pointerEvents === 'none' && visibleModals.length === 0) {
                console.warn('Body pointer events disabled but no visible modals');
                issuesFound = true;
            }
            
            
        } catch (error) {
            console.error('Error checking interface health:', error);
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ orphan backdrop'–æ–≤
    checkForOrphanBackdrops() {
        try {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            const visibleModals = document.querySelectorAll('.modal.show');
            
            if (backdrops.length > 0 && visibleModals.length === 0) {
                console.warn('Removing orphan modal backdrops');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // –¢–∞–∫–∂–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        } catch (error) {
            console.error('Error checking orphan backdrops:', error);
        }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é –æ—á–µ—Ä–µ–¥–∏
    showQueueSection() {
        try {
            const queueSection = document.getElementById('queue-section');
            if (queueSection && queueSection.style.display === 'none') {
                console.log('Showing queue section');
                queueSection.style.display = 'block';
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ
                this.refreshQueue();
            }
        } catch (error) {
            console.error('Error showing queue section:', error);
        }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (—Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
    toggleQueue() {
        try {
            const queueContent = document.getElementById('queue-content');
            const toggleButton = document.getElementById('toggle-queue');
            const icon = toggleButton.querySelector('i');
            
            if (queueContent.style.display === 'none') {
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                queueContent.style.display = 'block';
                icon.className = 'bi bi-chevron-up';
                toggleButton.innerHTML = '<i class="bi bi-chevron-up"></i> –°–≤–µ—Ä–Ω—É—Ç—å';
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                this.refreshQueue();
            } else {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                queueContent.style.display = 'none';
                icon.className = 'bi bi-chevron-down';
                toggleButton.innerHTML = '<i class="bi bi-chevron-down"></i> –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
            }
        } catch (error) {
            console.error('Error toggling queue:', error);
        }
    }
    
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å –∫–Ω–æ–ø–∫–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    showConversionResult(fileData) {
        try {
            const resultModal = this.createResultModal(fileData);
            document.body.appendChild(resultModal);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(resultModal);
            modal.show();
            
            // –£–¥–∞–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            resultModal.addEventListener('hidden.bs.modal', () => {
                resultModal.remove();
            });
            
        } catch (error) {
            console.error('Error showing conversion result:', error);
        }
    }
    
    // –°–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    createResultModal(fileData) {
        const modalId = `result-modal-${fileData.id}`;
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = modalId;
        modal.setAttribute('tabindex', '-1');
        
        const fileSize = fileData.fileSize ? this.formatFileSize(fileData.fileSize) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const fileName = fileData.file.name;
        const outputUrl = fileData.outputUrl;
        
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <h4>–í–∞—à —Ñ–∞–π–ª –≥–æ—Ç–æ–≤!</h4>
                        <p class="text-muted">–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: <strong>${this.escapeHtml(fileName)}</strong></p>
                        <p class="text-muted">–†–∞–∑–º–µ—Ä: <strong>${fileSize}</strong></p>
                        
                        <div class="d-grid gap-2 mt-4">
                            <a href="${outputUrl}" class="btn btn-success btn-lg" download>
                                <i class="bi bi-download me-2"></i>
                                –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                            </a>
                            <button type="button" class="btn btn-outline-primary" onclick="window.open('${outputUrl}', '_blank')">
                                <i class="bi bi-eye me-2"></i>
                                –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
        
        return modal;
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    cleanup() {
        try {
            if (this.interfaceMonitor) {
                clearInterval(this.interfaceMonitor);
                this.interfaceMonitor = null;
            }
            
            if (this.domObserver) {
                this.domObserver.disconnect();
                this.domObserver = null;
            }
            
            if (this.modalCleanupTimer) {
                clearTimeout(this.modalCleanupTimer);
                this.modalCleanupTimer = null;
            }
            
            console.log('Interface monitoring cleanup completed');
            
        } catch (error) {
            console.error('Error in cleanup:', error);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
let conversionInterface;
document.addEventListener('DOMContentLoaded', () => {
    conversionInterface = new ConversionInterface();
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    if (conversionInterface) {
        conversionInterface.cleanup();
    }
});

</script>
{% endblock %}
