{% extends 'converter/base.html' %}

{% block title %}–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .conversion-selector {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .conversion-selector:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .conversion-selector.active {
        border-color: #0d6efd;
        background-color: #e3f2fd;
        border-style: solid;
    }
    .format-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    .format-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .format-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .format-card.selected {
        border-color: #0d6efd;
        background-color: #e3f2fd;
        border-width: 2px;
    }
    .file-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
    }
    .file-drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e3f2fd;
    }
    .file-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .file-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background-color: white;
    }
    .file-item .file-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .progress {
        height: 6px;
    }
    .conversion-params {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .param-group {
        margin-bottom: 1rem;
    }
    .format-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ */
    [data-theme="dark"] .conversion-selector {
        border-color: rgba(102, 126, 234, 0.6);
        background: rgba(31, 41, 55, 0.8);
    }
    
    [data-theme="dark"] .format-card {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.4);
        color: #ffffff;
    }
    
    [data-theme="dark"] .format-card:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
    }
    
    [data-theme="dark"] .format-card.selected {
        background: rgba(102, 126, 234, 0.3);
        border-color: #667eea;
        color: #ffffff;
    }
    
    [data-theme="dark"] .file-drop-zone {
        background: rgba(31, 41, 55, 0.8);
        border-color: rgba(102, 126, 234, 0.6);
        color: #ffffff;
    }
    
    [data-theme="dark"] .file-drop-zone:hover,
    [data-theme="dark"] .file-drop-zone.dragover {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
    }
    
    [data-theme="dark"] .file-item {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.4);
        color: #ffffff;
    }
    
    [data-theme="dark"] .conversion-params {
        background: rgba(31, 41, 55, 0.8);
        color: #ffffff;
    }
    
    [data-theme="dark"] .param-group label {
        color: #ffffff !important;
    }
    
    [data-theme="dark"] .modal-content {
        background: rgba(17, 24, 39, 0.95);
        color: #ffffff;
    }
    
    [data-theme="dark"] .modal-header {
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    [data-theme="dark"] .modal-footer {
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    [data-theme="dark"] .list-group-item {
        background: rgba(55, 65, 81, 0.8);
        border-color: rgba(102, 126, 234, 0.3);
        color: #ffffff;
    }
    
    /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ */
    @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) .conversion-selector {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(31, 41, 55, 0.8);
        }
        
        :root:not([data-theme="light"]) .format-card {
            background: rgba(55, 65, 81, 0.8);
            border-color: rgba(102, 126, 234, 0.4);
            color: #ffffff;
        }
        
        :root:not([data-theme="light"]) .file-drop-zone {
            background: rgba(31, 41, 55, 0.8);
            border-color: rgba(102, 126, 234, 0.6);
            color: #ffffff;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="bi bi-arrow-left-right"></i>
        –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
    </h1>

    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
    <div class="row mb-4">
        <div class="col-12">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
            <div class="conversion-selector" id="conversion-selector">
                <div class="row">
                    <div class="col-md-5">
                        <h5>–ò–ó</h5>
                        <div class="format-grid" id="source-formats">
                            <div class="format-card" data-format="video">
                                <span class="format-icon">üé¨</span>
                                <strong>–í–∏–¥–µ–æ</strong>
                                <small class="d-block text-muted">MP4, AVI, MOV, MKV</small>
                            </div>
                            <div class="format-card" data-format="image">
                                <span class="format-icon">üñºÔ∏è</span>
                                <strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</strong>
                                <small class="d-block text-muted">JPG, PNG, BMP, TIFF</small>
                            </div>
                            <div class="format-card" data-format="audio">
                                <span class="format-icon">üéµ</span>
                                <strong>–ê—É–¥–∏–æ</strong>
                                <small class="d-block text-muted">MP3, WAV, FLAC, AAC</small>
                            </div>
                            <div class="format-card" data-format="document">
                                <span class="format-icon">üìÑ</span>
                                <strong>–î–æ–∫—É–º–µ–Ω—Ç—ã</strong>
                                <small class="d-block text-muted">PDF, DOC, DOCX, TXT</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-arrow-right display-4 text-primary"></i>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h5>–í</h5>
                        <div class="format-grid" id="target-formats">
                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4" id="upload-section" style="display: none;">
        <div class="col-12">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
            <div class="file-drop-zone" id="file-drop-zone">
                <i class="bi bi-cloud-upload display-1 text-primary"></i>
                <h4>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h4>
                <p class="text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 100MB</p>
                <input type="file" id="file-input" multiple accept="" style="display: none;">
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
    <div class="row mb-4" id="files-section" style="display: none;">
        <div class="col-12">
            <h3>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (<span id="file-count">0</span>)</h3>
            <div class="file-list" id="file-list">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
        </div>
    </div>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
    <div class="row mb-4" id="params-section" style="display: none;">
        <div class="col-12">
            <div class="conversion-params">
                <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h3>
                <div id="conversion-parameters">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="row mb-4" id="actions-section" style="display: none;">
        <div class="col-12">
            <div class="d-flex gap-3">
                <button class="btn btn-primary btn-lg" id="start-conversion" disabled>
                    <i class="bi bi-play-fill"></i>
                    –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
                </button>
                <button class="btn btn-secondary" id="clear-files">
                    <i class="bi bi-trash"></i>
                    –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫
                </button>
                <button class="btn btn-info" id="view-queue">
                    <i class="bi bi-list-task"></i>
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—á–µ—Ä–µ–¥—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á -->
<div class="modal fade" id="queue-modal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-list-task"></i>
                    –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="queue-content">
                    <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" id="refresh-queue">
                    <i class="bi bi-arrow-clockwise"></i>
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class ConversionInterface {
    constructor() {
        this.selectedSourceFormat = null;
        this.selectedTargetFormat = null;
        this.uploadedFiles = [];
        this.conversionTypes = {
            video: {
                name: '–í–∏–¥–µ–æ',
                targets: {
                    'gif': { name: 'GIF', icon: 'üéûÔ∏è', description: '–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
                    'mp4': { name: 'MP4', icon: 'üé¨', description: '–í–∏–¥–µ–æ —Ñ–æ—Ä–º–∞—Ç' },
                    'webm': { name: 'WebM', icon: 'üé•', description: '–í–µ–±-–≤–∏–¥–µ–æ' },
                    'avi': { name: 'AVI', icon: 'üìπ', description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç' }
                },
                accept: 'video/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            image: {
                name: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
                targets: {
                    'jpg': { name: 'JPG', icon: 'üì∏', description: 'JPEG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
                    'png': { name: 'PNG', icon: 'üñºÔ∏è', description: 'PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é' },
                    'webp': { name: 'WebP', icon: 'üåê', description: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç' },
                    'pdf': { name: 'PDF', icon: 'üìÑ', description: 'PDF –¥–æ–∫—É–º–µ–Ω—Ç' }
                },
                accept: 'image/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            audio: {
                name: '–ê—É–¥–∏–æ',
                targets: {
                    'mp3': { name: 'MP3', icon: 'üéµ', description: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç' },
                    'wav': { name: 'WAV', icon: 'üîä', description: '–ù–µ—Å–∂–∞—Ç—ã–π –∑–≤—É–∫' },
                    'flac': { name: 'FLAC', icon: 'üéº', description: 'Lossless –∫–∞—á–µ—Å—Ç–≤–æ' },
                    'ogg': { name: 'OGG', icon: 'üéß', description: '–û—Ç–∫—Ä—ã—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç' }
                },
                accept: 'audio/*',
                maxSize: 100 * 1024 * 1024 // 100MB
            },
            document: {
                name: '–î–æ–∫—É–º–µ–Ω—Ç—ã',
                targets: {
                    'pdf': { name: 'PDF', icon: 'üìÑ', description: 'PDF –¥–æ–∫—É–º–µ–Ω—Ç' },
                    'docx': { name: 'DOCX', icon: 'üìù', description: 'Word –¥–æ–∫—É–º–µ–Ω—Ç' },
                    'txt': { name: 'TXT', icon: 'üìÉ', description: '–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª' },
                    'html': { name: 'HTML', icon: 'üåê', description: 'HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞' }
                },
                accept: '.pdf,.doc,.docx,.txt,.rtf,.odt',
                maxSize: 50 * 1024 * 1024 // 50MB
            }
        };
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.setupDragAndDrop();
    }
    
    setupEventListeners() {
        // –í—ã–±–æ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        document.querySelectorAll('#source-formats .format-card').forEach(card => {
            card.addEventListener('click', (e) => {
                this.selectSourceFormat(e.currentTarget.dataset.format);
            });
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        document.getElementById('file-input').addEventListener('change', (e) => {
            this.handleFileSelection(e.target.files);
        });
        
        document.getElementById('file-drop-zone').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        document.getElementById('start-conversion').addEventListener('click', () => {
            this.startConversion();
        });
        
        document.getElementById('clear-files').addEventListener('click', () => {
            this.clearFiles();
        });
        
        document.getElementById('view-queue').addEventListener('click', () => {
            this.showQueue();
        });
        
        document.getElementById('refresh-queue').addEventListener('click', () => {
            this.refreshQueue();
        });
    }
    
    setupDragAndDrop() {
        const dropZone = document.getElementById('file-drop-zone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            this.handleFileSelection(e.dataTransfer.files);
        });
    }
    
    selectSourceFormat(format) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        document.querySelectorAll('#source-formats .format-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        document.querySelector(`#source-formats [data-format="${format}"]`).classList.add('selected');
        
        this.selectedSourceFormat = format;
        this.updateTargetFormats(format);
        this.updateFileInput();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('upload-section').style.display = 'block';
    }
    
    updateTargetFormats(sourceFormat) {
        const targetContainer = document.getElementById('target-formats');
        const targets = this.conversionTypes[sourceFormat].targets;
        
        targetContainer.innerHTML = '';
        
        Object.entries(targets).forEach(([format, info]) => {
            const card = document.createElement('div');
            card.className = 'format-card';
            card.dataset.format = format;
            card.innerHTML = `
                <span class="format-icon">${info.icon}</span>
                <strong>${info.name}</strong>
                <small class="d-block text-muted">${info.description}</small>
            `;
            
            card.addEventListener('click', () => {
                this.selectTargetFormat(format);
            });
            
            targetContainer.appendChild(card);
        });
    }
    
    selectTargetFormat(format) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        document.querySelectorAll('#target-formats .format-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        document.querySelector(`#target-formats [data-format="${format}"]`).classList.add('selected');
        
        this.selectedTargetFormat = format;
        this.updateConversionParameters();
    }
    
    updateFileInput() {
        const fileInput = document.getElementById('file-input');
        const acceptType = this.conversionTypes[this.selectedSourceFormat].accept;
        fileInput.accept = acceptType;
    }
    
    handleFileSelection(files) {
        Array.from(files).forEach(file => {
            if (this.validateFile(file)) {
                this.uploadedFiles.push({
                    file: file,
                    id: Date.now() + Math.random(),
                    status: 'ready',
                    progress: 0
                });
            }
        });
        
        this.updateFileList();
        this.updateUI();
    }
    
    validateFile(file) {
        const sourceFormat = this.conversionTypes[this.selectedSourceFormat];
        
        if (file.size > sourceFormat.maxSize) {
            alert(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${this.formatFileSize(sourceFormat.maxSize)}`);
            return false;
        }
        
        return true;
    }
    
    updateFileList() {
        const fileList = document.getElementById('file-list');
        const fileCount = document.getElementById('file-count');
        
        fileList.innerHTML = '';
        fileCount.textContent = this.uploadedFiles.length;
        
        this.uploadedFiles.forEach(fileData => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <div>
                        <strong>${fileData.file.name}</strong>
                        <small class="text-muted d-block">${this.formatFileSize(fileData.file.size)}</small>
                    </div>
                    <div>
                        <span class="badge bg-${this.getStatusColor(fileData.status)}">${this.getStatusText(fileData.status)}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="conversionInterface.removeFile('${fileData.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                ${fileData.progress > 0 ? `
                    <div class="progress mt-2">
                        <div class="progress-bar" style="width: ${fileData.progress}%"></div>
                    </div>
                ` : ''}
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    removeFile(fileId) {
        this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
        this.updateFileList();
        this.updateUI();
    }
    
    updateUI() {
        const hasFiles = this.uploadedFiles.length > 0;
        const hasFormats = this.selectedSourceFormat && this.selectedTargetFormat;
        
        document.getElementById('files-section').style.display = hasFiles ? 'block' : 'none';
        document.getElementById('params-section').style.display = hasFormats ? 'block' : 'none';
        document.getElementById('actions-section').style.display = hasFiles && hasFormats ? 'block' : 'none';
        document.getElementById('start-conversion').disabled = !hasFiles || !hasFormats;
    }
    
    updateConversionParameters() {
        const paramsContainer = document.getElementById('conversion-parameters');
        const sourceFormat = this.selectedSourceFormat;
        const targetFormat = this.selectedTargetFormat;
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        let parametersHTML = '';
        
        if (sourceFormat === 'video' && targetFormat === 'gif') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–®–∏—Ä–∏–Ω–∞ (px)</label>
                            <input type="number" class="form-control" value="480" min="144" max="1920">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">FPS</label>
                            <input type="number" class="form-control" value="15" min="10" max="30">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                            <select class="form-select">
                                <option value="medium">–°—Ä–µ–¥–Ω–µ–µ</option>
                                <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                                <option value="low">–ù–∏–∑–∫–æ–µ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="keep-original-size">
                            <label class="form-check-label" for="keep-original-size">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optimize-colors">
                            <label class="form-check-label" for="optimize-colors">
                                –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤
                            </label>
                        </div>
                    </div>
                </div>
            `;
        } else if (sourceFormat === 'image') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="param-group">
                            <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ (–¥–ª—è JPG)</label>
                            <input type="range" class="form-range" min="1" max="100" value="85">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="param-group">
                            <label class="form-label">–†–∞–∑–º–µ—Ä</label>
                            <select class="form-select">
                                <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π</option>
                                <option value="1920x1080">1920x1080</option>
                                <option value="1280x720">1280x720</option>
                                <option value="800x600">800x600</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        } else if (sourceFormat === 'audio') {
            parametersHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ë–∏—Ç—Ä–µ–π—Ç (kbps)</label>
                            <select class="form-select">
                                <option value="128">128</option>
                                <option value="192">192</option>
                                <option value="256">256</option>
                                <option value="320">320</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏</label>
                            <select class="form-select">
                                <option value="44100">44.1 kHz</option>
                                <option value="48000">48 kHz</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="param-group">
                            <label class="form-label">–ö–∞–Ω–∞–ª—ã</label>
                            <select class="form-select">
                                <option value="mono">–ú–æ–Ω–æ</option>
                                <option value="stereo" selected>–°—Ç–µ—Ä–µ–æ</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        } else {
            parametersHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    –î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
                </div>
            `;
        }
        
        paramsContainer.innerHTML = parametersHTML;
        this.updateUI();
    }
    
    startConversion() {
        if (!this.selectedSourceFormat || !this.selectedTargetFormat || this.uploadedFiles.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        const params = this.getConversionParams();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
        this.uploadedFiles.forEach(fileData => {
            this.submitConversionTask(fileData, params);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
        this.showNotification('–ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É!', 'success');
        
        // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—á–µ—Ä–µ–¥—å (–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        setTimeout(() => {
            this.showNotification('–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—á–µ—Ä–µ–¥—å" —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å', 'info');
        }, 2000);
    }
    
    getConversionParams() {
        const params = {
            source_format: this.selectedSourceFormat,
            target_format: this.selectedTargetFormat
        };
        
        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Ñ–æ—Ä–º—ã
        document.querySelectorAll('#conversion-parameters input, #conversion-parameters select').forEach(input => {
            if (input.type === 'checkbox') {
                params[input.id.replace('-', '_')] = input.checked;
            } else {
                params[input.id.replace('-', '_')] = input.value;
            }
        });
        
        return params;
    }
    
    async submitConversionTask(fileData, params) {
        const formData = new FormData();
        formData.append('file', fileData.file);
        formData.append('source_format', params.source_format);
        formData.append('target_format', params.target_format);
        formData.append('params', JSON.stringify(params));
        
        try {
            fileData.status = 'uploading';
            this.updateFileList();
            
            const response = await fetch('/app/api/conversion/submit/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                fileData.status = 'queued';
                fileData.taskId = result.task_id;
            } else {
                fileData.status = 'error';
            }
        } catch (error) {
            console.error('Error submitting task:', error);
            fileData.status = 'error';
        }
        
        this.updateFileList();
    }
    
    clearFiles() {
        this.uploadedFiles = [];
        this.updateFileList();
        this.updateUI();
    }
    
    async showQueue() {
        try {
            const modalElement = document.getElementById('queue-modal');
            if (!modalElement) {
                console.error('Queue modal element not found');
                this.showNotification('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Bootstrap –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded');
                this.showNotification('–û—à–∏–±–∫–∞: Bootstrap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            
            modal.show();
            
            // –û–∂–∏–¥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modalElement.addEventListener('shown.bs.modal', async () => {
                await this.refreshQueue();
            }, { once: true });
            
        } catch (error) {
            console.error('Error showing queue modal:', error);
            this.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—á–µ—Ä–µ–¥–∏', 'error');
        }
    }
    
    async refreshQueue() {
        const queueContent = document.getElementById('queue-content');
        if (!queueContent) {
            console.error('Queue content element not found');
            return;
        }
        
        queueContent.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"></div><p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–∏...</p></div>';
        
        try {
            console.log('Fetching queue from:', '/app/api/conversion/queue/');
            const response = await fetch('/app/api/conversion/queue/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            console.log('Queue response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Queue data received:', data);
                
                if (data.success !== false) {
                    this.renderQueue(data.tasks || []);
                } else {
                    queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
                }
            } else {
                const errorText = await response.text();
                console.error('Queue fetch error response:', errorText);
                queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏ (${response.status})</div>`;
            }
        } catch (error) {
            console.error('Error fetching queue:', error);
            queueContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
        }
    }
    
    renderQueue(tasks) {
        const queueContent = document.getElementById('queue-content');
        
        if (!Array.isArray(tasks) || tasks.length === 0) {
            queueContent.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ –∏–ª–∏ –∑–∞–¥–∞—á–∏ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã</div>';
            return;
        }
        
        try {
            let html = '<div class="list-group">';
            tasks.forEach((task, index) => {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const filename = this.escapeHtml(task.filename || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–π–ª');
                const sourceFormat = this.escapeHtml(task.source_format || 'unknown');
                const targetFormat = this.escapeHtml(task.target_format || 'unknown');
                const createdAt = task.created_at ? new Date(task.created_at).toLocaleString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const status = task.status || 'unknown';
                const progress = Math.max(0, Math.min(100, parseInt(task.progress) || 0));
                const errorMessage = task.error_message ? this.escapeHtml(task.error_message) : null;
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${filename}</h6>
                            <small>${createdAt}</small>
                        </div>
                        <p class="mb-1">
                            ${sourceFormat} ‚Üí ${targetFormat}
                            <span class="badge bg-${this.getStatusColor(status)} ms-2">${this.getStatusText(status)}</span>
                        </p>
                        ${progress > 0 ? `
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                        ${errorMessage ? `<small class="text-danger">–û—à–∏–±–∫–∞: ${errorMessage}</small>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            queueContent.innerHTML = html;
        } catch (error) {
            console.error('Error rendering queue:', error);
            queueContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏</div>';
        }
    }
    
    getStatusColor(status) {
        const colors = {
            ready: 'secondary',
            queued: 'info',
            uploading: 'warning',
            running: 'primary',
            done: 'success',
            error: 'danger',
            failed: 'danger'
        };
        return colors[status] || 'secondary';
    }
    
    getStatusText(status) {
        const texts = {
            ready: '–ì–æ—Ç–æ–≤',
            queued: '–í –æ—á–µ—Ä–µ–¥–∏',
            uploading: '–ó–∞–≥—Ä—É–∑–∫–∞',
            running: '–û–±—Ä–∞–±–æ—Ç–∫–∞',
            done: '–ì–æ—Ç–æ–≤–æ',
            error: '–û—à–∏–±–∫–∞',
            failed: '–ù–µ—É–¥–∞—á–∞'
        };
        return texts[status] || status;
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    showNotification(message, type = 'info') {
        try {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${this.escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —ç–∫—Ä–∞–Ω–∏–∑–∞—Ü–∏–∏ HTML
    escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            return String(unsafe || '');
        }
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
let conversionInterface;
document.addEventListener('DOMContentLoaded', () => {
    conversionInterface = new ConversionInterface();
});
</script>
{% endblock %}
