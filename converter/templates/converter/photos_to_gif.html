{% extends 'converter/base.html' %}
{% load static %}

{% block title %}–§–æ—Ç–æ –≤ GIF ‚Äî –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-3"><span>üì∏</span> <span data-translate="photos-to-gif-title">–§–æ—Ç–æ –≤ GIF</span></h2>
      <p class="text-muted" data-translate="photos-to-gif-desc">–ó–∞–≥—Ä—É–∑–∏—Ç–µ 1‚Äì100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ GIF. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–¥—Ä –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω.</p>
    </div>
  </div>

  <form id="photosToGifForm" class="conversion-settings" autocomplete="off">
    <div class="row g-4">
      <div class="col-12">
        <label class="form-label" data-translate="images-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
        <div id="dropzone" class="file-input-wrapper">
          <i class="bi bi-cloud-arrow-up upload-icon"></i>
          <p class="mb-2" data-translate="dropzone-prompt">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
          <small class="text-muted d-block" data-translate="supported-formats">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, WEBP, BMP, TIFF, HEIC, GIF</small>
          <input id="imagesInput" type="file" accept="image/*" multiple>
        </div>
        <div id="preview" class="mt-3 d-flex flex-wrap gap-2"></div>
      </div>

      <div class="col-12 col-md-6">
        <div class="settings-group">
          <label for="frameDuration" class="form-label" data-translate="frame-duration-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–¥—Ä–∞ (—Å–µ–∫)</label>
          <input type="number" min="0.05" step="0.05" value="0.5" id="frameDuration" class="form-control">
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="settings-group">
          <label for="outputSize" class="form-label" data-translate="gif-size-label">–†–∞–∑–º–µ—Ä GIF</label>
          <select id="outputSize" class="form-select">
            <option value="original" data-translate="original">–û—Ä–∏–≥–∏–Ω–∞–ª</option>
            <option value="320">320 x 320</option>
            <option value="480" selected>480 x 480</option>
            <option value="720">720 x 720</option>
            <option value="1080">1080 x 1080</option>
          </select>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="settings-group">
          <label for="colors" class="form-label" data-translate="colors-label">–¶–≤–µ—Ç–æ–≤ (–ø–∞–ª–∏—Ç—Ä–∞)</label>
          <input type="number" min="2" max="256" value="128" id="colors" class="form-control">
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="settings-group">
          <label for="sortOrder" class="form-label" data-translate="sort-order-label">–ü–æ—Ä—è–¥–æ–∫ –∫–∞–¥—Ä–æ–≤</label>
          <select id="sortOrder" class="form-select">
            <option value="filename" selected data-translate="sort-by-filename">–ü–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (A‚ÜíZ)</option>
            <option value="upload" data-translate="sort-by-upload">–í –ø–æ—Ä—è–¥–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏</option>
            <option value="reverse" data-translate="sort-reverse">–û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
          </select>
        </div>
      </div>

      <div class="col-12">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="loop" checked>
          <label class="form-check-label" for="loop" data-translate="loop">–ó–∞—Ü–∏–∫–ª–∏—Ç—å</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="pingpong">
          <label class="form-check-label" for="pingpong" data-translate="pingpong">–≠—Ñ—Ñ–µ–∫—Ç –ø–∏–Ω–≥-–ø–æ–Ω–≥</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="optimize" checked>
          <label class="form-check-label" for="optimize" data-translate="optimize">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å</label>
        </div>
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-gear"></i>
          <span class="ms-2" data-translate="convert">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
        </button>
        <button type="button" id="clearBtn" class="btn btn-outline-secondary" data-translate="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  </form>

  <div id="progressBox" class="loading-spinner">
    <div class="spinner-border" role="status"></div>
    <p class="mt-3 mb-0" data-translate="creating-gif">–°–æ–∑–¥–∞–Ω–∏–µ GIF‚Ä¶ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
  </div>

  <div id="resultBox" class="mt-4" style="display:none;">
    <div class="alert alert-success" data-translate="done-result">–ì–æ—Ç–æ–≤–æ! –ù–∏–∂–µ ‚Äî –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
    <div class="card p-3">
      <div class="d-flex flex-wrap gap-3 align-items-start">
        <img id="resultPreview" class="gif-preview" alt="GIF preview" />
        <div>
          <a id="downloadLink" class="btn btn-primary mb-2" download>
            <i class="bi bi-download"></i>
            <span class="ms-2" data-translate="download-gif">–°–∫–∞—á–∞—Ç—å GIF</span>
          </a>
          <div id="fileInfo" class="text-muted small"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const dropzone = document.getElementById('dropzone');
  const imagesInput = document.getElementById('imagesInput');
  const preview = document.getElementById('preview');
  const form = document.getElementById('photosToGifForm');
  const clearBtn = document.getElementById('clearBtn');
  const progressBox = document.getElementById('progressBox');
  const resultBox = document.getElementById('resultBox');
  const resultPreview = document.getElementById('resultPreview');
  const downloadLink = document.getElementById('downloadLink');
  const fileInfo = document.getElementById('fileInfo');

  let files = [];

  function showProgress(show){ progressBox.style.display = show ? 'block' : 'none'; }
  function showResult(show){ resultBox.style.display = show ? 'block' : 'none'; }

  function validateImages(list){
    const arr = Array.from(list || []);
    const filtered = arr.filter(f => /^image\//.test(f.type) || /\.(jpe?g|png|webp|bmp|tiff?|gif|heic|heif)$/i.test(f.name));
    return filtered;
  }

  function renderPreview(){
    preview.innerHTML = '';
    files.forEach((f, idx) => {
      const url = URL.createObjectURL(f);
      const wrap = document.createElement('div');
      wrap.style.width = '96px';
      wrap.style.height = '96px';
      wrap.style.overflow = 'hidden';
      wrap.style.borderRadius = '8px';
      wrap.style.border = '1px solid #e1e5f2';
      wrap.style.position = 'relative';

      const img = document.createElement('img');
      img.src = url;
      img.alt = f.name;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      wrap.appendChild(img);

      const badge = document.createElement('span');
      badge.textContent = idx + 1;
      badge.style.position = 'absolute';
      badge.style.left = '6px';
      badge.style.top = '6px';
      badge.style.background = '#667eea';
      badge.style.color = '#fff';
      badge.style.fontSize = '12px';
      badge.style.borderRadius = '999px';
      badge.style.padding = '2px 6px';
      wrap.appendChild(badge);

      preview.appendChild(wrap);
    });
  }

  function addFiles(list){
    const newFiles = validateImages(list);
    files = files.concat(newFiles);
    if(files.length > 100){
      alert('–ú–∞–∫—Å–∏–º—É–º 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞ —Ä–∞–∑');
      files = files.slice(0, 100);
    }
    renderPreview();
  }

  dropzone.addEventListener('click', () => imagesInput.click());
  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-primary'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-primary'));
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault(); dropzone.classList.remove('border-primary');
    addFiles(e.dataTransfer.files);
  });
  imagesInput.addEventListener('change', (e) => addFiles(e.target.files));

  clearBtn.addEventListener('click', () => {
    files = []; imagesInput.value = ''; preview.innerHTML = ''; showResult(false);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    showResult(false);
    if(files.length < 1){
      alert('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è GIF –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–Ω–∏–º—É–º 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–∏ –æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–∞–¥—Ä –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω.');
      return;
    }

    const totalSize = files.reduce((s, f) => s + (f.size || 0), 0);
    if(totalSize > 100 * 1024 * 1024){
      alert('–°—É–º–º–∞—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–µ–≤—ã—à–∞–µ—Ç 100 –ú–ë.');
      return;
    }

    const fd = new FormData();
    files.forEach(f => fd.append('images', f, f.name));

    fd.append('frame_duration', document.getElementById('frameDuration').value || '0.5');
    fd.append('output_size', document.getElementById('outputSize').value || '480');
    fd.append('colors', document.getElementById('colors').value || '128');
    fd.append('loop', document.getElementById('loop').checked ? 'true' : 'false');
    fd.append('sort_order', document.getElementById('sortOrder').value || 'filename');
    fd.append('pingpong', document.getElementById('pingpong').checked ? 'true' : 'false');
    fd.append('optimize', document.getElementById('optimize').checked ? 'true' : 'false');

    showProgress(true);

    try {
      const resp = await fetch('{% url "converter:api_photos_to_gif" %}', {
        method: 'POST',
        body: fd
      });
      const data = await resp.json();
      if(!resp.ok || !data.success){
        throw new Error((data && (data.error || data.message)) || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ GIF');
      }

      const url = data.gif_url;
      resultPreview.src = url;
      downloadLink.href = url;
      downloadLink.setAttribute('download', (url.split('/').pop() || 'result.gif'));

      const info = data.file_info || {};
      fileInfo.textContent = `–ö–∞–¥—Ä–æ–≤: ${info.frames ?? files.length}, ` +
        `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–¥—Ä–∞: ${info.duration_per_frame ?? Number(document.getElementById('frameDuration').value || '0.5')} —Å, ` +
        `–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${info.total_duration ? Number(info.total_duration).toFixed(2) : (files.length * Number(document.getElementById('frameDuration').value || '0.5')).toFixed(2)} —Å, ` +
        `–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${info.file_size ? (info.file_size/1024/1024).toFixed(2) + ' –ú–ë' : '‚Äî'}, ` +
        `–†–∞–∑–º–µ—Ä—ã: ${info.dimensions || (document.getElementById('outputSize').value === 'original' ? 'Original' : document.getElementById('outputSize').value + 'x' + document.getElementById('outputSize').value)}`;

      showResult(true);
    } catch (err){
      alert(err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ GIF');
    } finally {
      showProgress(false);
    }
  });
})();
</script>
{% endblock %}

